pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- main
function _init()
	create_player()
	init_msg()
	create_msg("persotest","bonjour",
	"au revoir")
end

function _update()
	if scene=="menu" then
		update_menu()
	end
	if not messages[1] then
		  player_movement()
	end
	update_camera()
	update_msg()
end

function _draw()
	cls()
	draw_map()
	draw_player()
	 
	draw_ui()
	draw_msg()
end
-->8
-- map 

function draw_map()
	map(0,0,0,0,128,64)
end 
 
function check_flag(flag,x,y)
	local sprite=mget(x,y)
	return fget(sprite,flag)
end

function update_camera()
	camx=flr(p.x/16)*16
	camy=flr(p.y/16)*16
	camera(camx*8,camy*8)
end

function old_camera()   
	camx=mid(0,p.x-7.5,31-15)
	camy=mid(0,p.y-7.5,31-15)
	camera(camx*8,camy*8)
end

function next_tile(x,y)
	sprite=mget(x,y)
	mset(x,y,sprite+1)
end

function pick_up_key(x,y)
	next_tile(x,y)
	p.keys+=1
	sfx(0)
end

function open_door(x,y)
	next_tile(x,y)
	p.keys-=1
	sfx(1)
end	
-->8
-- player

function create_player()
	p={
		x=6,y=8,
		ox=0,oy=0,
		start_ox=0,start_oy=0,
		anim_t=0,
		sprite=0,
		keys=0}
end

function player_movement()
 newx = p.x
 newy = p.y
 if p.anim_t == 0 then
    newox = 0
    newoy = 0
   if btn(⬅️) then
     newx -= 1
     newox = 8
     p.flip=true
   elseif btn(➡️) then
     newx += 1
     newox = -8
     p.flip=false
   elseif btn(⬆️) then
     newy -= 1
     newoy = 8
   elseif btn(⬇️) then
     newy += 1
     newoy = -8
   end
  end
  
	interact(newx,newy)
	
	if (p.x!=newx or p.y!=newy)	and
	not check_flag(0,newx,newy) then
		-- on avance
		p.x=mid(0,newx,127)
		p.y=mid(0,newy,63)
		p.start_ox=newox
		p.start_oy=newoy
		p.anim_t=1
	end
	--animation
	p.anim_t=max(p.anim_t-0.125,0)
	p.ox=p.start_ox*p.anim_t
	p.oy=p.start_oy*p.anim_t
	--marche
	if p.anim_t>=0.5 then
		p.sprite=1
	else
		p.sprite=0
	end
end

function interact(x,y)
	if check_flag(1,x,y) then
		pick_up_key(x,y)
	elseif check_flag(2,x,y)
	and p.keys>0 then
	open_door(x,y)
	end
end

function draw_player()
	spr(p.sprite,p.x*8+p.ox,
					p.y*8+p.oy,1,1,p.flip)
	
end  
-->8
--ui

function draw_ui()
	camera()
	
	palt(0,false)
	palt(7,true)
	spr(48,2,2)
	palt()
	
	print_outline("X"..p.keys,10,2)
end

function print_outline(text,x,y)
	print(text,x-1,y,0)
	print(text,x+1,y,0)
	print(text,x,y-1,0)
	print(text,x,y+1,0)
	print(text,x,y,7)
	
end
-->8
--messages

function init_msg()
	message={}
end


function create_msg(name,...)
	msg_title=name
	messages={...}
end

function update_msg()
	if (btn(❎)) then
		deli(messages,1)
	end
end

function draw_msg()
	if messages[1] then
		local y=100
		rectfill(6,y,40,y+6,2)
		print(msg_title,7,y+1,7)
		print(messages[1],3,y+10,7)
	end
end
__gfx__
955555909555559000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffff8f00000000
55f55f5055f55f5000000000000000000000000000000000000000000000000000000000000000000000000000000000fffffffff8fffffffffff8a800000000
5f1ff1f05f1ff1f000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffff8fffffff8f00000000
5effffe05effffe000000000000000000000000000000000000000000000000000000000000000000000000000000000fffffffffffeffffffffffff00000000
551221505512215000000000000000000000000000000000000000000000000000000000000000000000000000000000fffffffffffffffffff7ffff00000000
00f22f0000f22f0000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffff8fffffff7a7fff00000000
002222000022220000000000000000000000000000000000000000000000000000000000000000000000000000000000fffffffffffffefffff7ffff00000000
001001000001500000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffff00000000
fffffffff000000ff0000000ff5555ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff0000000f00400400f555555f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffccfffffe1ff1ef04144100f514415f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fc1ccffffeffffef04444440f544445f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99ccccffff0330fff022220ff50aa05f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff77ccccff9999fff422224ff40004ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff779cfff4444ffff1111ffff0000ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff9f9ffff0ff0ffff1ff1ffff0ff0ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fffffffff999999ff000000f95555595000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff999999990000000055f55f55000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff4fff449fcffcf9041441405f1ff1f5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f44444449ffffff9044444405effffe5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5414444f993333990098890055122155000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444ff9f33f9ff048840ff5f22f5f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f94fff4fff3333ffff8888ffff2222ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff4fff4fff0ff0ffff9ff9ffff1ff1ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001010101000000000000000000000000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0c0c0c0c0c0c0c0c0c0c0c0e0c0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c110c120c210c220c130c230c0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0d0c0e0c0d0c0c0c0d0c0c0e0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0c0c0c0c0c0e0c0c0c0c0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0d0c0c0c0c0c0c0c0c0e0c0c0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0c0c0c0c0d0c0c0c0c0e0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0d0c0c0e0c0c0c100c0c0c0d0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0c0c0c200c0c0c0c0c0c0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0c0c0c0c0c0c0e0c0c0c0c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100001905000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
